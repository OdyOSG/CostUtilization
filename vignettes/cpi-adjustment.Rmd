---
title: "Adjusting Healthcare Costs for Inflation Using CPI"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Adjusting Healthcare Costs for Inflation Using CPI}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  eval = FALSE
)
```

```{r setup}
library(CostUtilization)
library(dplyr)
library(ggplot2)
```

## Introduction

When analyzing healthcare costs over multiple years, it's important to account for inflation to make meaningful comparisons. The CostUtilization package includes built-in functionality to adjust costs using the Consumer Price Index (CPI).

## Understanding CPI Adjustment

The Consumer Price Index (CPI) measures the average change in prices over time. By adjusting historical costs to a common year (e.g., 2023 dollars), we can:

- Compare costs across different time periods fairly
- Identify real cost trends vs. inflation
- Standardize multi-year analyses

## Basic CPI Adjustment

### Loading CPI Data

The package includes default CPI data for U.S. medical care costs:

```{r}
# Load default CPI data
cpiData <- loadCpiData()

# View the data
head(cpiData)

# Plot CPI trend
ggplot(cpiData, aes(x = year, y = cpi)) +
  geom_line(color = "blue", size = 1) +
  geom_point(color = "blue", size = 2) +
  labs(
    title = "Medical Care CPI Over Time",
    x = "Year",
    y = "CPI Index Value"
  ) +
  theme_minimal()
```

### Calculating Adjustment Factors

To adjust costs from one year to another:

```{r}
# Calculate adjustment factor from 2015 to 2023
factor <- calculateCpiAdjustmentFactor(
  fromYear = 2015,
  toYear = 2023,
  cpiData = cpiData
)

print(paste("Adjustment factor:", round(factor, 3)))

# Example: $1,000 in 2015 dollars
cost2015 <- 1000
cost2023 <- cost2015 * factor
print(paste("$1,000 in 2015 =", round(cost2023, 2), "in 2023 dollars"))
```

## Using CPI Adjustment in Cost Analysis

### Basic Analysis with CPI Adjustment

```{r}
# Connect to database
connection <- DatabaseConnector::connect(connectionDetails)

# Run cost analysis with CPI adjustment to 2023 dollars
results <- calculateCostOfCare(
  connection = connection,
  cdmDatabaseSchema = "cdm",
  cohortDatabaseSchema = "results",
  cohortTable = "cohort",
  cohortId = 1,
  anchorCol = "cohort_start_date",
  startOffsetDays = -365,
  endOffsetDays = 0,
  cpiAdjustment = TRUE,
  cpiTargetYear = 2023,
  returnFormat = "list"
)

# View results
print(results$results)

# The results now include both original and adjusted costs
# - total_cost: Original cost values
# - adjusted_cost: CPI-adjusted cost values
# - adjusted_cost_pppm: Adjusted cost per patient per month
```

### Comparing Adjusted vs. Unadjusted Costs

```{r}
# Run analysis without adjustment
resultsUnadjusted <- calculateCostOfCare(
  connection = connection,
  cdmDatabaseSchema = "cdm",
  cohortDatabaseSchema = "results",
  cohortTable = "cohort",
  cohortId = 1,
  anchorCol = "cohort_start_date",
  startOffsetDays = -365,
  endOffsetDays = 0,
  cpiAdjustment = FALSE
)

# Run with adjustment
resultsAdjusted <- calculateCostOfCare(
  connection = connection,
  cdmDatabaseSchema = "cdm",
  cohortDatabaseSchema = "results",
  cohortTable = "cohort",
  cohortId = 1,
  anchorCol = "cohort_start_date",
  startOffsetDays = -365,
  endOffsetDays = 0,
  cpiAdjustment = TRUE,
  cpiTargetYear = 2023
)

# Compare results
comparison <- tibble(
  metric = c("Total Cost", "Cost PPPM"),
  unadjusted = c(
    resultsUnadjusted$total_cost[1],
    resultsUnadjusted$cost_pppm[1]
  ),
  adjusted_2023 = c(
    resultsAdjusted$adjusted_cost[1],
    resultsAdjusted$adjusted_cost_pppm[1]
  )
) %>%
  mutate(
    percent_change = (adjusted_2023 - unadjusted) / unadjusted * 100
  )

print(comparison)
```

## Using Custom CPI Data

You can provide your own CPI data for specialized analyses:

```{r}
# Create custom CPI data file
customCpi <- tibble(
  year = 2010:2023,
  cpi = c(
    100, 102, 105, 108, 110, 113, 116, 119,
    122, 125, 128, 132, 138, 145
  ) # Example values
)

# Save to CSV
write.csv(customCpi, "custom_cpi.csv", row.names = FALSE)

# Use custom CPI in analysis
results <- calculateCostOfCare(
  connection = connection,
  cdmDatabaseSchema = "cdm",
  cohortDatabaseSchema = "results",
  cohortTable = "cohort",
  cohortId = 1,
  cpiAdjustment = TRUE,
  cpiTargetYear = 2023,
  cpiDataPath = "custom_cpi.csv"
)
```

## Multi-Year Trend Analysis

CPI adjustment is particularly useful for analyzing cost trends over multiple years:

```{r}
# Analyze costs for multiple cohorts across different years
years <- 2015:2023
allResults <- list()

for (year in years) {
  # Create year-specific cohort
  cohortId <- year - 2014 # Cohort IDs 1-9

  # Run analysis with CPI adjustment
  results <- calculateCostOfCare(
    connection = connection,
    cdmDatabaseSchema = "cdm",
    cohortDatabaseSchema = "results",
    cohortTable = "annual_cohorts",
    cohortId = cohortId,
    cpiAdjustment = TRUE,
    cpiTargetYear = 2023
  )

  allResults[[as.character(year)]] <- results %>%
    mutate(year = year)
}

# Combine results
trendData <- bind_rows(allResults)

# Plot trend
ggplot(trendData, aes(x = year)) +
  geom_line(aes(y = total_cost, color = "Nominal"), size = 1) +
  geom_line(aes(y = adjusted_cost, color = "2023 Dollars"), size = 1) +
  geom_point(aes(y = total_cost), color = "blue", size = 2) +
  geom_point(aes(y = adjusted_cost), color = "red", size = 2) +
  scale_color_manual(
    values = c("Nominal" = "blue", "2023 Dollars" = "red"),
    name = "Cost Type"
  ) +
  labs(
    title = "Healthcare Cost Trends: Nominal vs. Inflation-Adjusted",
    x = "Year",
    y = "Total Cost",
    caption = "Adjusted to 2023 dollars using medical care CPI"
  ) +
  theme_minimal() +
  scale_y_continuous(labels = scales::dollar)
```

## Advanced CPI Settings

### Creating CPI Adjustment Settings

```{r}
# Create settings object
cpiSettings <- getCpiAdjustmentSettings(
  enableCpiAdjustment = TRUE,
  targetYear = 2023,
  cpiType = "medical" # or "all_items" for general CPI
)

print(cpiSettings)
```

### Summarizing CPI-Adjusted Results

```{r}
# Get detailed summary of CPI adjustment impact
costData <- DatabaseConnector::querySql(
  connection,
  "SELECT person_id, cost as total_cost,
          cost * cpi_factor as adjusted_cost
   FROM cost_analysis_results"
) %>%
  as_tibble()

summary <- summarizeCpiAdjustedCosts(
  costData,
  originalCostCol = "total_cost",
  adjustedCostCol = "adjusted_cost"
)

print(summary)
# Shows:
# - Total and mean costs (original and adjusted)
# - Overall adjustment ratio
# - Median values
```

## Best Practices

1. **Choose appropriate target year**: Usually the most recent year or the year of analysis
2. **Document CPI source**: Always note whether using medical CPI or general CPI
3. **Consider cohort timeframes**: Ensure CPI data covers all years in your analysis
4. **Validate adjustments**: Check that adjustment factors are reasonable
5. **Report both values**: Present both nominal and adjusted costs for transparency

## Troubleshooting

### Common Issues

1. **Missing CPI data for certain years**
   - The package will interpolate between available years
   - For years outside the range, you'll get an error

2. **Different currency considerations**
   - CPI adjustment assumes same currency throughout
   - For multi-country analyses, adjust each currency separately

3. **Performance with large datasets**
   - CPI adjustment adds minimal overhead
   - The adjustment table is indexed for fast joins

```{r cleanup, eval = FALSE}
# Disconnect
DatabaseConnector::disconnect(connection)
```

## Conclusion

CPI adjustment is a powerful feature for making healthcare costs comparable across time periods. By standardizing to a common year, you can identify real cost trends and make more informed decisions based on your analyses.
