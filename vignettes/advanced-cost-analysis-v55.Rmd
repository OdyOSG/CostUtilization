---
title: "Advanced Cost Analysis with CDM v5.5"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Advanced Cost Analysis with CDM v5.5}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width = 7,
  fig.height = 5,
  message = FALSE,
  warning = FALSE,
  eval = FALSE
)
```

## Introduction

This vignette covers advanced cost analysis techniques using the CDM v5.5 long-format cost table. We'll explore complex event filtering, multi-cohort comparisons, temporal cost patterns, and sophisticated analytical approaches that leverage the enhanced capabilities of CDM v5.5.

## Setup

```{r setup}
library(CostUtilization)
library(DatabaseConnector)
library(dplyr)
library(tidyr)
library(purrr)
library(rlang)
library(ggplot2)
library(cli)

# Setup connection and ensure CDM v5.5 format
connectionDetails <- Eunomia::getEunomiaConnectionDetails()
connection <- DatabaseConnector::connect(connectionDetails)

# Ensure we have CDM v5.5 cost data
injectCostData(connection, cdmDatabaseSchema = "main", seed = 123)
transformCostToCdmV5dot5(connectionDetails, cdmDatabaseSchema = "main")
```

## Advanced Event Filtering with CDM v5.5

### Hierarchical Concept Filtering

CDM v5.5's enhanced traceability allows for more sophisticated event filtering:

```{r hierarchical-filtering}
# Create comprehensive cardiovascular event filters
createCvEventFilters <- function() {
  list(
    # Acute cardiovascular events
    list(
      name = "Acute MI",
      domain = "Condition",
      conceptIds = c(4329847L, 314666L, 4108217L, 312327L)
    ),
    list(
      name = "Stroke Events", 
      domain = "Condition",
      conceptIds = c(372924L, 375557L, 443454L, 4148906L)
    ),
    
    # Cardiovascular procedures
    list(
      name = "Revascularization",
      domain = "Procedure", 
      conceptIds = c(4336464L, 4178904L, 4273391L)  # PCI, CABG, stenting
    ),
    list(
      name = "Cardiac Imaging",
      domain = "Procedure",
      conceptIds = c(4019824L, 4305178L, 4143316L, 4052536L)  # Echo, cath, stress test, CT
    ),
    
    # Medications
    list(
      name = "Antiplatelet Therapy",
      domain = "Drug",
      conceptIds = c(1308216L, 1310149L, 1322184L)  # Aspirin, clopidogrel, prasugrel
    ),
    list(
      name = "Statins",
      domain = "Drug", 
      conceptIds = c(1545958L, 1549686L, 1592085L, 1510202L)  # Various statins
    ),
    list(
      name = "ACE Inhibitors",
      domain = "Drug",
      conceptIds = c(1308842L, 1310756L, 1373225L)  # Lisinopril, enalapril, etc.
    ),
    
    # Monitoring and diagnostics
    list(
      name = "Lipid Panel",
      domain = "Measurement",
      conceptIds = c(3027114L, 3023103L, 3019900L, 3020891L)  # Cholesterol tests
    ),
    list(
      name = "Cardiac Biomarkers",
      domain = "Measurement", 
      conceptIds = c(3016407L, 3005593L, 3003510L)  # Troponin, BNP, CK-MB
    )
  )
}

cvEventFilters <- createCvEventFilters()

# Create cardiovascular cohort
DatabaseConnector::executeSql(connection, "
  CREATE TABLE main.cv_cohort AS
  SELECT DISTINCT
    1 AS cohort_definition_id,
    co.person_id AS subject_id,
    MIN(co.condition_start_date) AS cohort_start_date,
    DATE(MIN(co.condition_start_date), '+1 year') AS cohort_end_date
  FROM main.condition_occurrence co
  WHERE co.condition_concept_id IN (4329847, 314666, 4108217, 372924, 375557, 443454)
  GROUP BY co.person_id
")

cohortSize <- DatabaseConnector::querySql(
  connection,
  "SELECT COUNT(DISTINCT subject_id) AS n FROM main.cv_cohort"
)
cli::cli_alert_info("Created CV cohort with {cohortSize$n} patients")
```

### Multi-Domain Cost Analysis

Analyze costs across multiple clinical domains simultaneously:

```{r multi-domain-analysis}
# Create settings for comprehensive CV cost analysis
cvCostSettings <- createCostOfCareSettings(
  anchorCol = "cohort_start_date",
  startOffsetDays = -30L,   # 30 days before event
  endOffsetDays = 365L,     # 1 year after event
  eventFilters = cvEventFilters,
  costConceptId = 31973L    # Total charge
)

# Run comprehensive analysis
cvCostResults <- calculateCostOfCare(
  connection = connection,
  cdmDatabaseSchema = "main",
  cohortDatabaseSchema = "main",
  cohortTable = "cv_cohort",
  cohortId = 1,
  costOfCareSettings = cvCostSettings,
  verbose = TRUE
)

cli::cli_h3("Cardiovascular Event Cost Analysis")
print(cvCostResults$results)
print(cvCostResults$diagnostics)
```

## Temporal Cost Pattern Analysis

CDM v5.5's enhanced temporal fields enable sophisticated time-based analyses:

### Cost Trajectory Analysis

```{r temporal-analysis}
# Define multiple time windows for trajectory analysis
timeWindows <- tibble(
  windowName = c("pre_acute", "acute_phase", "early_recovery", "late_recovery", "maintenance"),
  startDays = c(-90L, -7L, 1L, 31L, 91L),
  endDays = c(-8L, 0L, 30L, 90L, 365L),
  phase = c("Pre-event", "Acute", "Early Recovery", "Late Recovery", "Maintenance")
)

# Analyze cost trajectory using purrr for clean iteration
costTrajectory <- timeWindows |>
  pmap_dfr(function(windowName, startDays, endDays, phase) {
    
    settings <- createCostOfCareSettings(
      anchorCol = "cohort_start_date",
      startOffsetDays = startDays,
      endOffsetDays = endDays,
      eventFilters = cvEventFilters,
      costConceptId = 31973L
    )
    
    result <- calculateCostOfCare(
      connection = connection,
      cdmDatabaseSchema = "main",
      cohortDatabaseSchema = "main",
      cohortTable = "cv_cohort",
      cohortId = 1,
      costOfCareSettings = settings,
      verbose = FALSE
    )
    
    result$results |>
      mutate(
        windowName = windowName,
        phase = phase,
        windowDays = endDays - startDays + 1,
        costPerDay = total_cost / windowDays
      )
  })

# Display trajectory results
cli::cli_h3("Cost Trajectory Analysis")
print(costTrajectory |> select(phase, total_cost, cost_pppm, costPerDay))

# Visualize cost trajectory
trajectoryPlot <- costTrajectory |>
  mutate(phase = factor(phase, levels = timeWindows$phase)) |>
  ggplot(aes(x = phase, y = costPerDay, group = 1)) +
  geom_line(color = "darkblue", size = 1.2) +
  geom_point(size = 3, color = "darkblue") +
  labs(
    title = "Daily Cost Trajectory Around Cardiovascular Events",
    subtitle = "Based on CDM v5.5 long-format cost data",
    x = "Care Phase",
    y = "Average Cost Per Day ($)"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

print(trajectoryPlot)
```

### Cost Component Analysis

Leverage CDM v5.5's granular cost concepts:

```{r cost-component-analysis}
# Define cost components with their OMOP concept IDs
costComponents <- tibble(
  component = c("total_charge", "total_cost", "paid_by_payer", "paid_by_patient", 
                "patient_copay", "patient_coinsurance", "patient_deductible", "amount_allowed"),
  conceptId = c(31973L, 31985L, 31980L, 31981L, 31974L, 31975L, 31976L, 31979L),
  category = c("Billed", "Incurred", "Insurance", "Patient", 
               "Patient", "Patient", "Patient", "Allowed")
)

# Analyze each cost component
componentResults <- costComponents |>
  pmap_dfr(function(component, conceptId, category) {
    
    settings <- createCostOfCareSettings(
      anchorCol = "cohort_start_date",
      startOffsetDays = 0L,
      endOffsetDays = 365L,
      costConceptId = conceptId
    )
    
    result <- calculateCostOfCare(
      connection = connection,
      cdmDatabaseSchema = "main",
      cohortDatabaseSchema = "main",
      cohortTable = "cv_cohort",
      cohortId = 1,
      costOfCareSettings = settings,
      verbose = FALSE
    )
    
    result$results |>
      mutate(
        component = component,
        conceptId = conceptId,
        category = category
      )
  })

# Display component analysis
cli::cli_h3("Cost Component Analysis")
componentSummary <- componentResults |>
  select(component, category, total_cost, cost_pppm) |>
  arrange(desc(total_cost))

print(componentSummary)

# Visualize cost components by category
componentPlot <- componentResults |>
  ggplot(aes(x = reorder(component, total_cost), y = total_cost, fill = category)) +
  geom_bar(stat = "identity") +
  scale_fill_brewer(palette = "Set2") +
  labs(
    title = "Cardiovascular Care Costs by Component",
    subtitle = "CDM v5.5 enables granular cost analysis",
    x = "Cost Component",
    y = "Total Cost ($)",
    fill = "Category"
  ) +
  theme_minimal() +
  coord_flip()

print(componentPlot)
```

## Multi-Cohort Comparative Analysis

### Stratified Cost Analysis

```{r stratified-analysis}
# Create age-stratified cohorts
DatabaseConnector::executeSql(connection, "
  CREATE TABLE main.age_stratified_cv_cohort AS
  SELECT 
    c.*,
    CASE 
      WHEN (YEAR(c.cohort_start_date) - p.year_of_birth) < 50 THEN 1
      WHEN (YEAR(c.cohort_start_date) - p.year_of_birth) < 65 THEN 2
      WHEN (YEAR(c.cohort_start_date) - p.year_of_birth) < 80 THEN 3
      ELSE 4
    END AS age_group_id,
    CASE 
      WHEN (YEAR(c.cohort_start_date) - p.year_of_birth) < 50 THEN 'Under 50'
      WHEN (YEAR(c.cohort_start_date) - p.year_of_birth) < 65 THEN '50-64'
      WHEN (YEAR(c.cohort_start_date) - p.year_of_birth) < 80 THEN '65-79'
      ELSE '80+'
    END AS age_group_name
  FROM main.cv_cohort c
  JOIN main.person p ON c.subject_id = p.person_id
")

# Get age group distribution
ageDistribution <- DatabaseConnector::querySql(connection, "
  SELECT 
    age_group_id,
    age_group_name,
    COUNT(*) AS n_patients
  FROM main.age_stratified_cv_cohort
  GROUP BY age_group_id, age_group_name
  ORDER BY age_group_id
") |>
  rename_with(tolower)

cli::cli_h3("Age group distribution:")
print(ageDistribution)

# Analyze costs by age group using modern R approaches
ageGroupAnalysis <- ageDistribution |>
  pmap_dfr(function(age_group_id, age_group_name, n_patients) {
    
    # Create temporary cohort table for this age group
    tempTableName <- paste0("temp_age_", age_group_id)
    
    DatabaseConnector::executeSql(connection, glue::glue("
      CREATE TEMPORARY TABLE {tempTableName} AS
      SELECT 
        age_group_id AS cohort_definition_id,
        subject_id,
        cohort_start_date,
        cohort_end_date
      FROM main.age_stratified_cv_cohort
      WHERE age_group_id = {age_group_id}
    "))
    
    settings <- createCostOfCareSettings(
      anchorCol = "cohort_start_date",
      startOffsetDays = 0L,
      endOffsetDays = 365L,
      costConceptId = 31973L
    )
    
    result <- calculateCostOfCare(
      connection = connection,
      cdmDatabaseSchema = "main",
      cohortDatabaseSchema = "main",
      cohortTable = tempTableName,
      cohortId = age_group_id,
      costOfCareSettings = settings,
      verbose = FALSE
    )
    
    # Clean up temporary table
    DatabaseConnector::executeSql(connection, glue::glue("DROP TABLE {tempTableName}"))
    
    result$results |>
      mutate(
        ageGroupId = age_group_id,
        ageGroupName = age_group_name,
        nPatients = n_patients
      )
  })

# Display age-stratified results
cli::cli_h3("Cost analysis by age group:")
ageGroupSummary <- ageGroupAnalysis |>
  select(ageGroupName, nPatients, total_cost, cost_pppm, visits_per_1000_py) |>
  arrange(ageGroupId)

print(ageGroupSummary)

# Visualize age-stratified costs
ageStratPlot <- ageGroupAnalysis |>
  pivot_longer(
    cols = c(cost_pppm, visits_per_1000_py),
    names_to = "metric",
    values_to = "value"
  ) |>
  mutate(
    metric = case_when(
      metric == "cost_pppm" ~ "Cost PPPM ($)",
      metric == "visits_per_1000_py" ~ "Visits per 1000 PY",
      TRUE ~ metric
    )
  ) |>
  ggplot(aes(x = ageGroupName, y = value, fill = ageGroupName)) +
  geom_bar(stat = "identity") +
  facet_wrap(~metric, scales = "free_y") +
  scale_fill_brewer(palette = "Set3") +
  labs(
    title = "Healthcare Utilization by Age Group",
    subtitle = "Cardiovascular patients in CDM v5.5",
    x = "Age Group",
    y = "Value"
  ) +
  theme_minimal() +
  theme(
    legend.position = "none",
    axis.text.x = element_text(angle = 45, hjust = 1)
  )

print(ageStratPlot)
```

### Gender-Based Cost Comparison

```{r gender-analysis}
# Create gender-stratified analysis
DatabaseConnector::executeSql(connection, "
  CREATE TABLE main.gender_stratified_cv_cohort AS
  SELECT 
    c.*,
    p.gender_concept_id,
    CASE 
      WHEN p.gender_concept_id = 8507 THEN 'Male'
      WHEN p.gender_concept_id = 8532 THEN 'Female'
      ELSE 'Other/Unknown'
    END AS gender_name
  FROM main.cv_cohort c
  JOIN main.person p ON c.subject_id = p.person_id
")

# Analyze by gender
genderGroups <- c("Male", "Female")

genderAnalysis <- tibble(gender = genderGroups) |>
  pmap_dfr(function(gender) {
    
    tempTableName <- paste0("temp_gender_", tolower(gender))
    
    DatabaseConnector::executeSql(connection, glue::glue("
      CREATE TEMPORARY TABLE {tempTableName} AS
      SELECT 
        1 AS cohort_definition_id,
        subject_id,
        cohort_start_date,
        cohort_end_date
      FROM main.gender_stratified_cv_cohort
      WHERE gender_name = '{gender}'
    "))
    
    settings <- createCostOfCareSettings(
      anchorCol = "cohort_start_date",
      startOffsetDays = 0L,
      endOffsetDays = 365L,
      eventFilters = cvEventFilters,
      costConceptId = 31973L
    )
    
    result <- calculateCostOfCare(
      connection = connection,
      cdmDatabaseSchema = "main",
      cohortDatabaseSchema = "main",
      cohortTable = tempTableName,
      cohortId = 1,
      costOfCareSettings = settings,
      verbose = FALSE
    )
    
    DatabaseConnector::executeSql(connection, glue::glue("DROP TABLE {tempTableName}"))
    
    result$results |>
      mutate(gender = gender)
  })

cli::cli_h3("Cost analysis by gender:")
print(genderAnalysis |> select(gender, total_cost, cost_pppm, visits_per_1000_py))
```

## Advanced Diagnostic Analysis

### Patient Flow Analysis

```{r patient-flow-analysis}
# Run detailed analysis with comprehensive diagnostics
detailedSettings <- createCostOfCareSettings(
  anchorCol = "cohort_start_date",
  startOffsetDays = 0L,
  endOffsetDays = 365L,
  eventFilters = cvEventFilters,
  costConceptId = 31973L
)

detailedAnalysis <- calculateCostOfCare(
  connection = connection,
  cdmDatabaseSchema = "main",
  cohortDatabaseSchema = "main",
  cohortTable = "cv_cohort",
  cohortId = 1,
  costOfCareSettings = detailedSettings,
  verbose = TRUE
)

# Analyze patient attrition
attritionData <- detailedAnalysis$diagnostics |>
  mutate(
    step_order = row_number(),
    retention_rate = n_persons / max(n_persons) * 100,
    attrition_rate = (max(n_persons) - n_persons) / max(n_persons) * 100
  )

cli::cli_h3("Patient attrition analysis:")
attritionSummary <- attritionData |>
  select(step_name, n_persons, retention_rate, attrition_rate) |>
  mutate(across(c(retention_rate, attrition_rate), ~round(.x, 1)))

print(attritionSummary)

# Visualize patient flow
attritionPlot <- attritionData |>
  ggplot(aes(x = reorder(step_name, step_order))) +
  geom_bar(aes(y = n_persons), stat = "identity", fill = "steelblue", alpha = 0.7) +
  geom_line(aes(y = retention_rate * max(n_persons) / 100, group = 1), 
            color = "red", size = 1.2) +
  geom_point(aes(y = retention_rate * max(n_persons) / 100), 
             color = "red", size = 3) +
  scale_y_continuous(
    name = "Number of Persons",
    sec.axis = sec_axis(~ . / max(attritionData$n_persons) * 100, 
                        name = "Retention Rate (%)")
  ) +
  labs(
    title = "Patient Attrition Through Analysis Steps",
    subtitle = "CDM v5.5 provides detailed diagnostic information",
    x = "Analysis Step"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

print(attritionPlot)
```

### Event Distribution Analysis

```{r event-distribution}
# Analyze event distribution if available
if (nrow(attritionData) > 1 && "n_events" %in% names(attritionData)) {
  eventDistribution <- attritionData |>
    filter(step_name != "00_initial_cohort") |>
    mutate(
      events_per_person = ifelse(n_persons > 0, n_events / n_persons, 0),
      step_label = paste0(step_name, "\n(", round(events_per_person, 1), " events/person)")
    )
  
  eventDistPlot <- eventDistribution |>
    ggplot(aes(x = step_label, y = n_events)) +
    geom_bar(stat = "identity", fill = "darkgreen") +
    labs(
      title = "Event Distribution by Analysis Step",
      subtitle = "Events per person shown in parentheses",
      x = "Step (Events per Person)",
      y = "Total Events"
    ) +
    theme_minimal() +
    theme(axis.text.x = element_text(angle = 45, hjust = 1))
  
  print(eventDistPlot)
}
```

## Performance Optimization for CDM v5.5

### Efficient Query Patterns

```{r performance-optimization}
# Example of efficient batch processing for multiple analyses
performBatchAnalysis <- function(connection, cohortTable, cohortIds, settingsList) {
  
  # Use map2 for clean parallel processing
  results <- map2_dfr(cohortIds, settingsList, function(cohortId, settings) {
    
    result <- calculateCostOfCare(
      connection = connection,
      cdmDatabaseSchema = "main",
      cohortDatabaseSchema = "main",
      cohortTable = cohortTable,
      cohortId = cohortId,
      costOfCareSettings = settings,
      verbose = FALSE
    )
    
    result$results |>
      mutate(cohortId = cohortId)
  })
  
  return(results)
}

# Example usage with multiple cost concepts
costConcepts <- c(31973L, 31985L, 31980L, 31981L)  # charge, cost, payer, patient
cohortIds <- rep(1, length(costConcepts))

settingsList <- map(costConcepts, function(conceptId) {
  createCostOfCareSettings(
    anchorCol = "cohort_start_date",
    startOffsetDays = 0L,
    endOffsetDays = 365L,
    costConceptId = conceptId
  )
})

# Run batch analysis
batchResults <- performBatchAnalysis(
  connection = connection,
  cohortTable = "cv_cohort",
  cohortIds = cohortIds,
  settingsList = settingsList
)

cli::cli_h3("Batch analysis results:")
print(batchResults |> select(cohortId, total_cost, cost_pppm))
```

## Clean Up

```{r cleanup}
# Clean up all temporary tables
tablesToDrop <- c(
  "main.cv_cohort",
  "main.age_stratified_cv_cohort", 
  "main.gender_stratified_cv_cohort"
)

walk(tablesToDrop, function(table) {
  DatabaseConnector::executeSql(connection, glue::glue("DROP TABLE IF EXISTS {table}"))
})

# Disconnect
DatabaseConnector::disconnect(connection)
cli::cli_alert_success("Analysis complete and database cleaned up")
```

## Summary

This vignette demonstrated advanced cost analysis techniques with CDM v5.5:

### Key Advanced Features

1. **Hierarchical Event Filtering** - Complex multi-domain event definitions
2. **Temporal Cost Patterns** - Trajectory analysis using enhanced date fields
3. **Cost Component Analysis** - Granular analysis of different cost types
4. **Multi-Cohort Comparisons** - Stratified analysis by demographics
5. **Advanced Diagnostics** - Patient flow and event distribution analysis
6. **Performance Optimization** - Efficient batch processing patterns

### CDM v5.5 Advantages

- **Enhanced Traceability** - Better linkage between costs and clinical events
- **Temporal Precision** - Multiple date fields for detailed timing analysis
- **Standardized Concepts** - Consistent cost concept usage across analyses
- **Analytical Flexibility** - Long format enables complex aggregations
- **Quality Assurance** - Comprehensive diagnostic information

### Modern R Practices

- **Functional Programming** - Using `purrr` for clean iteration
- **Tidy Evaluation** - Using `rlang` for dynamic column references
- **Pipeline Operations** - Leveraging `dplyr` for data transformation
- **Visualization** - Creating informative plots with `ggplot2`

The combination of CDM v5.5's enhanced cost data structure with modern R programming practices enables sophisticated, reproducible healthcare cost analyses that can address complex research questions while maintaining code clarity and performance.