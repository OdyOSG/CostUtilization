---
title: "FeatureExtraction Package Integration"
author: "CostUtilization Development Team"
date: "`r Sys.Date()`"
output: 
  rmarkdown::html_vignette:
    toc: true
    toc_depth: 3
vignette: >
  %\VignetteIndexEntry{FeatureExtraction Package Integration}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  eval = FALSE  # Set to FALSE to avoid running during package build
)
```

## Introduction

The CostUtilization package now provides seamless integration with the OHDSI FeatureExtraction package through standardized `CovariateData` objects. This integration enables cost and utilization analyses to be easily incorporated into larger OHDSI study pipelines.

## Key Benefits

- **Standardized Format**: Results conform to FeatureExtraction package standards
- **Rich Metadata**: Comprehensive analysis metadata and parameter tracking  
- **Andromeda Backend**: Efficient handling of large datasets
- **OHDSI Compatibility**: Direct integration with study packages

## Basic Usage

### Setup

```{r}
library(CostUtilization)
library(dplyr)

# Setup test database (using Eunomia)
databaseFile <- getEunomiaDuckDb()
con <- DBI::dbConnect(duckdb::duckdb(databaseFile))
con <- transformCostToCdmV5dot5(con)

# Create test cohort
cohort_data <- data.frame(
  cohort_definition_id = 1L,
  subject_id = 1:100,
  cohort_start_date = as.Date("2020-01-01"),
  cohort_end_date = as.Date("2020-12-31")
)
DBI::dbWriteTable(con, "cohort", cohort_data, overwrite = TRUE)
```

### Basic Cost Analysis

```{r}
# Create analysis settings
settings <- createCostOfCareSettings(
  anchorCol = "cohort_start_date",
  startOffsetDays = 0L,
  endOffsetDays = 365L,
  costConceptId = 31973L  # Total charge
)

# Run cost analysis
results <- calculateCostOfCare(
  connection = con,
  cdmDatabaseSchema = "main",
  cohortDatabaseSchema = "main",
  cohortTable = "cohort",
  cohortId = 1,
  costOfCareSettings = settings
)

# View original results
print(results$results)
```

### Convert to FeatureExtraction Format

```{r}
# Convert to CovariateData format
covariateData <- createCostCovariateData(
  costResults = results,
  costOfCareSettings = settings,
  cohortId = 1,
  databaseId = "EunomiaDemo"
)

# View the converted data
summary(covariateData)
```

## Advanced Examples

### CPI-Adjusted Analysis

```{r}
# Create CPI adjustment data
cpi_file <- tempfile(fileext = ".csv")
cpi_data <- data.frame(
  year = 2015:2025,
  adj_factor = seq(0.85, 1.15, length.out = 11)
)
write.csv(cpi_data, cpi_file, row.names = FALSE)

# Settings with CPI adjustment
cpi_settings <- createCostOfCareSettings(
  costConceptId = 31985L,  # Total cost
  cpiAdjustment = TRUE,
  cpiFilePath = cpi_file
)

# Run analysis
cpi_results <- calculateCostOfCare(
  connection = con,
  cdmDatabaseSchema = "main",
  cohortDatabaseSchema = "main",
  cohortTable = "cohort",
  cohortId = 1,
  costOfCareSettings = cpi_settings
)

# Convert to FeatureExtraction format
cpi_covariateData <- createCostCovariateData(
  costResults = cpi_results,
  costOfCareSettings = cpi_settings,
  cohortId = 1,
  analysisId = 2L
)

summary(cpi_covariateData)
```

### Event-Filtered Analysis

```{r}
# Define clinical event filters
event_filters <- list(
  list(
    name = "Cardiovascular Conditions",
    domain = "Condition", 
    conceptIds = c(313217L, 314666L, 320128L)
  ),
  list(
    name = "Cardiac Procedures",
    domain = "Procedure",
    conceptIds = c(4006969L, 4022492L)
  )
)

# Settings with event filtering
filtered_settings <- createCostOfCareSettings(
  startOffsetDays = -180L,
  endOffsetDays = 180L,
  costConceptId = 31980L,  # Paid by payer
  eventFilters = event_filters
)

# Run analysis
filtered_results <- calculateCostOfCare(
  connection = con,
  cdmDatabaseSchema = "main",
  cohortDatabaseSchema = "main",
  cohortTable = "cohort",
  cohortId = 1,
  costOfCareSettings = filtered_settings
)

# Convert to FeatureExtraction format
filtered_covariateData <- createCostCovariateData(
  costResults = filtered_results,
  costOfCareSettings = filtered_settings,
  cohortId = 1,
  analysisId = 3L
)

summary(filtered_covariateData)
```

## Working with CovariateData

### Extracting Information

```{r}
# Extract covariate details
covariates <- dplyr::collect(covariateData$covariates)
covariateRef <- dplyr::collect(covariateData$covariateRef)
analysisRef <- dplyr::collect(covariateData$analysisRef)

# Join for detailed view
detailed_covariates <- covariates |>
  left_join(covariateRef, by = "covariateId") |>
  left_join(analysisRef, by = "analysisId")

print(detailed_covariates)
```

### Filtering Covariates

```{r}
# Get only cost-related covariates
cost_covariates <- detailed_covariates |>
  filter(grepl("Cost|Charge", covariateName))

# Get utilization metrics
utilization_covariates <- detailed_covariates |>
  filter(grepl("Visit|Event", covariateName))

print(cost_covariates)
print(utilization_covariates)
```

## Integration with OHDSI Packages

### Preparing for CohortMethod

```{r}
# Cost covariates can be combined with other FeatureExtraction covariates
# for use in comparative effectiveness studies

# Example: Combine with demographic covariates
library(FeatureExtraction)

demographic_settings <- createCovariateSettings(
  useDemographicsGender = TRUE,
  useDemographicsAge = TRUE,
  useDemographicsAgeGroup = TRUE
)

# In practice, you would combine these in your CohortMethod analysis
# The cost covariates from createCostCovariateData() can be merged
# with other covariate data for comprehensive analysis
```

### Metadata and Documentation

```{r}
# Access comprehensive metadata
metaData <- attr(covariateData, "metaData")

# Analysis parameters
print(metaData$call)

# Population characteristics  
print(paste("Population size:", metaData$populationSize))
print(paste("Metric type:", metaData$metricType))

# Execution details
print(paste("Package version:", metaData$packageVersion))
print(paste("Execution time:", metaData$executionTime))
```

## Convenience Functions

### Quick Conversion

```{r}
# Use the convenience function for quick conversion
converted_data <- convertToFeatureExtractionFormat(
  costResults = results,
  costOfCareSettings = settings,
  cohortId = 1,
  databaseId = "QuickDemo"
)

summary(converted_data)
```

## Best Practices

### Memory Management

```{r}
# Always close Andromeda objects when done
Andromeda::close(covariateData)
Andromeda::close(cpi_covariateData)
Andromeda::close(filtered_covariateData)
Andromeda::close(converted_data)
```

### Quality Checks

```{r}
# Verify covariate data quality
print(paste("Number of covariates:", nrow(dplyr::collect(covariateData$covariateRef))))
print(paste("Number of persons:", length(unique(dplyr::collect(covariateData$covariates)$rowId))))

# Check for missing values
covariates <- dplyr::collect(covariateData$covariates)
print(paste("Missing values:", sum(is.na(covariates$covariateValue))))
```

## Cleanup

```{r}
# Close database connection
DBI::dbDisconnect(con, shutdown = TRUE)

# Remove temporary files
unlink(databaseFile)
unlink(cpi_file)
```

## Summary

The FeatureExtraction integration provides:

1. **Standardized covariate format** compatible with OHDSI tools
2. **Rich metadata** for analysis documentation and reproducibility
3. **Flexible analysis options** including CPI adjustment and event filtering
4. **Efficient data handling** through Andromeda backend
5. **Easy integration** with downstream analysis packages

This integration makes cost and utilization analyses first-class citizens in the OHDSI ecosystem, enabling their use in comparative effectiveness research, prediction modeling, and other advanced analytics.

## Further Reading

- [FeatureExtraction Package Documentation](https://ohdsi.github.io/FeatureExtraction/)
- [CohortMethod Integration Guide](https://ohdsi.github.io/CohortMethod/)
- [OHDSI Methods Library](https://ohdsi.github.io/MethodsLibrary/)
- [Cost Analysis Best Practices](inst/doc/FeatureExtraction_Integration.md)